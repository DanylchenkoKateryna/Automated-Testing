version: 2.1

orbs:
  win: circleci/windows@5.0
  codecov: codecov/codecov@4.1.0

jobs:
  test:
    description: Setup and run application tests
    #parallelism: 4
    executor:
      name: win/server-2022
          
    steps:
      - checkout
      - attach_workspace:
          at: .
       
      # Restore cache for NuGet packages
      - restore_cache:
          keys:
            - nuget-cache-{{ checksum "Calculator/Calculator_Exam_CommandProject.sln" }}
            - nuget-cache-
     
      - run:
          name: "Run Application Tests"
          command: |
            cmd.exe /c circleci_test.bat
            #msbuild "Calculator/Tests/AnalizerClassLibrary.Tests.csproj" /p:Configuration=Release
             
            #circleci tests glob "Calculator/Tests/**/*Tests.cs" | circleci tests split > C:\Users\circleci\project\Calculator\Tests\tests-to-run
            
            # Read the content of the file
            #$testFiles = cat C:\Users\circleci\project\Calculator\Tests\tests-to-run
            #$removePath="Calculator\"
            #foreach ($testFile in $testFiles) {
                    #$relativePath = $testFile.Substring($removePath.Length) -replace '\\', '.' -replace '\.cs$', ''
                    #$relativePath
                    #dotnet test Calculator/Tests/AnalizerClassLibrary.Tests.csproj --filter $relativePath --configuration Release --no-build --logger "junit;LogFileName=test-results.xml"  
            #}
            #dotnet.exe test Calculator/Tests/AnalizerClassLibrary.Tests.csproj -v n --configuration Release --no-build --logger "junit;LogFileName=C:\Users\circleci\project\Calculator\Tests\TestResults\test-results.xml" 
          when: always
       
      - run:
          name: "List Test Results"
          command: |
            dir Calculator\TestResults
            dir Calculator\CodeCoverageResults
            
      - run:
          name: Install ReportGenerator
          command: dotnet tool install -g dotnet-reportgenerator-globaltool
          
      - run:
          name: Generate coverage report
          command: |
            mkdir Calculator/CodeCoverageResults/GeneralResult
            $coverage_files = Get-ChildItem -Path "Calculator/CodeCoverageResults" -Filter "coverage.cobertura.xml" -Recurse
            $coverage_files
            foreach ($coverage_file in $coverage_files.FullName) {
              $coverage_file
              reportgenerator -reports:$coverage_file -targetdir:Calculator/CodeCoverageResults/GeneralResult -reporttypes:Html
            }

      - store_artifacts:
          path: Calculator/CodeCoverageResults/GeneralResult
          destination: coverage-report
      
      - codecov/upload:
          file: Calculator/CodeCoverageResults/coverage.cobertura.xml
          token: CODECOV_TOKEN
      
      # Store test result artifacts
      - store_artifacts:
          path: Calculator/TestResults
          destination: test-results

      # Store test results for CircleCI Insights
      - store_test_results:
          path: Calculator/TestResults
 
  build:
    description: Build application with Release configuration
    executor:
      name: win/server-2022
    steps:
      - checkout
      - attach_workspace:
          at: .
     # Restore cache for NuGet packages
      - restore_cache:
          keys:
            - nuget-cache-{{ checksum "Calculator/Calculator_Exam_CommandProject.sln" }}
            - nuget-cache-
      - run:
          name: "Install project dependencies"
          command: nuget restore Calculator/Calculator_Exam_CommandProject.sln
      
      # Save cache for NuGet packages
      - save_cache:
          paths:
            - C:/Users/circleci/.nuget/packages
          key: nuget-cache-{{ checksum "Calculator/Calculator_Exam_CommandProject.sln" }}
      - run:
          name: "Build Application according to some given configuration"
          command: cmd.exe /c Calculator_Buiild.bat
      - persist_to_workspace:
          root: .    # Root directory to persist
          paths:
            - .nuget/
            - Calculator/
      

workflows:
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
